<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用者中心與S3檔案上傳</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1121.0/aws-sdk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.0/dist/amazon-cognito-identity.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 font-sans">

<div id="login-redirect-container" class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full transition-all duration-300 transform text-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">歡迎來到使用者中心</h2>
    <p class="text-gray-600 mb-4">請登入以繼續</p>
    <button id="login-redirect-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">登入會員</button>
</div>

<div id="profile-container" class="hidden bg-white p-8 rounded-lg shadow-lg max-w-md w-full transition-all duration-300 transform">
    <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">使用者中心</h2>
    <div class="text-center mb-4">
        <p class="text-gray-600">歡迎，<span id="user-email-display" class="font-bold text-blue-600"></span></p>
    </div>
    
    <div class="border-t border-gray-200 pt-4 mt-4">
        <h3 class="text-xl font-bold text-gray-800 mb-4">檔案上傳</h3>
        <input type="file" id="file-input" class="w-full border border-gray-300 p-2 rounded-lg mb-4 cursor-pointer">
        <button id="upload-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">上傳檔案</button>
        <p id="upload-status" class="mt-4 text-center text-sm"></p>
    </div>

    <button id="logout-btn" class="w-full mt-6 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">登出</button>
</div>

<script>
    // 請在這裡替換成你的 AWS Cognito 和 S3 資訊
    const COGNITO_USER_POOL_ID = 'us-east-1_0Kius6YBt'; // 你的 User Pool ID
    const COGNITO_CLIENT_ID = '5ug0mo74oh6ma666kd9dkpbqk5'; // 你的 App Client ID
    const S3_BUCKET_REGION = 'us-east-1'; // 你的 S3 儲存桶所在的區域
    const S3_BUCKET_NAME = '2025ithome-ducky '; // 你的 S3 儲存桶名稱
    // 請替換為你的 Identity Pool ID
    const IDENTITY_POOL_ID = 'us-east-1:4682c527-47ae-4357-b444-bdec69d3f4e2';
    // 請在這裡設定你的 Cognito 託管 UI URL 和回呼 URL
    const COGNITO_HOSTED_UI_URL = 'https://ducky-unique123.auth.us-east-1.amazoncognito.com/login?client_id=5ug0mo74oh6ma666kd9dkpbqk5&response_type=token&scope=email+openid+profile&redirect_uri=https://www.ducky-test.tw/index.html';
    
    const loginRedirectContainer = document.getElementById('login-redirect-container');
    const loginRedirectBtn = document.getElementById('login-redirect-btn');
    const profileContainer = document.getElementById('profile-container');
    const userEmailDisplay = document.getElementById('user-email-display');
    const logoutBtn = document.getElementById('logout-btn');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadStatus = document.getElementById('upload-status');
    
    // 初始化 Cognito 認證
    const poolData = {
        UserPoolId: COGNITO_USER_POOL_ID,
        ClientId: COGNITO_CLIENT_ID
    };
    const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

    let cognitoUser;

    // 處理登入導向按鈕點擊
    loginRedirectBtn.addEventListener('click', () => {
        window.location.href = COGNITO_HOSTED_UI_URL;
    });

    // 處理檔案上傳
    uploadBtn.addEventListener('click', async () => {
        const file = fileInput.files[0];
        if (!file) {
            uploadStatus.textContent = '請先選擇一個檔案！';
            uploadStatus.className = 'mt-4 text-center text-red-500 text-sm';
            return;
        }

        uploadStatus.textContent = '上傳中，請稍候...';
        uploadStatus.className = 'mt-4 text-center text-gray-600 text-sm';

        // 創建使用者專屬的資料夾名稱
        const userEmail = userEmailDisplay.textContent;
        const folderName = userEmail.split('@')[0]; // 移除 @ 和後面的網域
        const fileName = file.name;

        // 檔案上傳參數
        const uploadParams = {
            Bucket: S3_BUCKET_NAME,
            Key: `${folderName}/${fileName}`,
            Body: file,
            ACL: 'private' // 確保檔案為私有，只有擁有權限的人能存取
        };
        
        const s3 = new AWS.S3({
            params: { Bucket: S3_BUCKET_NAME },
            region: S3_BUCKET_REGION
        });

        try {
            await s3.upload(uploadParams).promise();
            uploadStatus.textContent = '檔案上傳成功！';
            uploadStatus.className = 'mt-4 text-center text-green-500 text-sm';
        } catch (err) {
            console.error("上傳失敗:", err);
            uploadStatus.textContent = '檔案上傳失敗: ' + err.message;
            uploadStatus.className = 'mt-4 text-center text-red-500 text-sm';
        }
    });

    // 處理登出
    logoutBtn.addEventListener('click', () => {
        // 使用 Cognito 提供的登出 URL，並指定重導向 URI
        window.location.href = `https://ducky-unique123.auth.us-east-1.amazoncognito.com/logout?client_id=${COGNITO_CLIENT_ID}&logout_uri=https://www.ducky-test.tw/index.html`;
    });

    // 輔助函數：顯示使用者個人資料頁面
    const showProfilePage = (email) => {
        loginRedirectContainer.classList.add('hidden');
        profileContainer.classList.remove('hidden');
        userEmailDisplay.textContent = email;
    };

    // 檢查 URL 中的 JWT Tokens 或緩存的會話
    const urlParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = urlParams.get('access_token');
    const idToken = urlParams.get('id_token');

    if (accessToken && idToken) {
        // 1. 如果 URL 中有 tokens，表示從 Cognito 託管 UI 登入回來
        const userPayload = JSON.parse(atob(idToken.split('.')[1]));
        const userEmail = userPayload.email;

        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: IDENTITY_POOL_ID,
            Logins: {
                [`cognito-idp.${S3_BUCKET_REGION}.amazonaws.com/${COGNITO_USER_POOL_ID}`]: idToken
            }
        });

        AWS.config.credentials.get((err) => {
            if (err) {
                console.error("無法取得 AWS 憑證:", err);
                alert("登入失敗，請檢查你的設定。");
                return;
            }
            console.log("登入成功！");
            showProfilePage(userEmail);
        });
        
        // 清除 URL 中的 tokens 以保持網址乾淨
        history.replaceState(null, '', location.pathname + location.search);

    } else {
        // 2. 如果 URL 中沒有 tokens，檢查是否有有效的緩存會話
        cognitoUser = userPool.getCurrentUser();
        if (cognitoUser != null) {
            cognitoUser.getSession((err, session) => {
                if (err) {
                    console.error("無法取得會話:", err);
                    loginRedirectContainer.classList.remove('hidden');
                    profileContainer.classList.add('hidden');
                    return;
                }
                if (session.isValid()) {
                    const userPayload = session.getIdToken().decodePayload();
                    const userEmail = userPayload.email;
                    showProfilePage(userEmail);
                }
            });
        } else {
            // 如果沒有 tokens 且沒有緩存會話，顯示登入按鈕
            loginRedirectContainer.classList.remove('hidden');
            profileContainer.classList.add('hidden');
        }
    }
</script>

</body>
</html>
