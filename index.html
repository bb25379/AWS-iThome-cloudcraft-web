<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duckyæœƒå“¡å°ˆå€</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    #user-info { border: 1px solid #ccc; padding: 20px; margin: 20px auto; width: 60%; }
    img { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Day13 - æœƒå“¡å°ˆå±¬é é¢</h1>
  <div id="status">å°šæœªç™»å…¥</div>
  <div id="user-info" style="display:none;">
    <h2 id="welcome"></h2>
    <p id="email"></p>
    <img id="avatar" src="" alt="å¤§é ­ç…§" style="width:80px; border-radius:50%;">
  </div>

  <script>
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error("JWT è§£æå¤±æ•—:", e);
        return null;
      }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");

    if (code) {
      // ğŸ”¹ å‘¼å« Cognito OAuth2 Token Endpoint
      fetch("https://ducky-unique123.auth.us-east-1.amazoncognito.com/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `grant_type=authorization_code&client_id=YOUR_CLIENT_ID&code=${code}&redirect_uri=https://www.ducky-test.tw/index.html`
      })
      .then(res => res.json())
      .then(data => {
        if (data.id_token) {
          const user = parseJwt(data.id_token);

          document.getElementById("status").innerText = "âœ… å·²ç™»å…¥";
          document.getElementById("user-info").style.display = "block";

          // é¡¯ç¤ºå€‹äººè³‡è¨Š
          document.getElementById("welcome").innerText = `å“ˆå›‰ï¼Œ${user.name || user["cognito:username"]}ï¼`;
          document.getElementById("email").innerText = `ç›®å‰ç™»å…¥å¸³è™Ÿï¼š${user.email}`;

          if (user.picture) {
            document.getElementById("avatar").src = user.picture;
          } else {
            document.getElementById("avatar").style.display = "none";
          }

          // ğŸ”¹ è·³è½‰åˆ°ä½¿ç”¨è€…å°ˆå±¬é é¢ï¼ˆä¾ username å€åˆ†ï¼‰
          // window.location.href = `https://www.ducky-test.tw/${user["cognito:username"]}/index.html`;
        } else {
          document.getElementById("status").innerText = "ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥";
        }
      })
      .catch(err => {
        console.error("Token å–å¾—å¤±æ•—:", err);
        document.getElementById("status").innerText = "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
      });
    } else {
      // ğŸ”¹ æ²’æœ‰ code â†’ é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
      const authUrl = https://ducky-unique123.auth.us-east-1.amazoncognito.com/login?client_id=5ug0mo74oh6ma666kd9dkpbqk5&response_type=code&scope=email+openid+profile&redirect_uri=https://www.ducky-test.tw/index.html";
      document.getElementById("status").innerHTML = `âŒ å°šæœªç™»å…¥ <br><br><a href="${authUrl}">ğŸ‘‰ é»æ­¤ç™»å…¥</a>`;
    }
  </script>
</body>
</html>
