<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ducky會員專區</title>
  <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            text-align: center;
        }
        .container {
            background-color: white;
            padding: 40px 60px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
        }
        p {
            color: #666;
            line-height: 1.6;
        }
        .login-button {
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none; /* 移除超連結底線 */
            margin-top: 20px;
            display: inline-block;
        }
        .login-button:hover {
            background-color: #0056b3;
        }
  </style>
</head>
<body>
  <h1>Day13 v4- 會員專屬頁面</h1>
  <a href="https://ducky-unique123.auth.us-east-1.amazoncognito.com/login?client_id=5ug0mo74oh6ma666kd9dkpbqk5&response_type=code&scope=email+openid+profile&redirect_uri=https://www.ducky-test.tw/auth/callback/index.html" class="login-button">
      登入會員
  </a>
  <div id="status">尚未登入</div>
  <div id="user-info" style="display:none;">
    <h2 id="welcome"></h2>
    <p id="email"></p>
    <img id="avatar" src="" alt="大頭照" style="width:80px; border-radius:50%;">
  </div>

<script>
  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
    return JSON.parse(jsonPayload);
  }

  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");

  if (code) {
    fetch("https://ducky-unique123.auth.us-east-1.amazoncognito.com/oauth2/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `grant_type=authorization_code&client_id=5ug0mo74oh6ma666kd9dkpbqk5&code=${code}&redirect_uri=https://www.ducky-test.tw/index.html`
    })
    .then(res => res.json())
    .then(data => {
      const user = parseJwt(data.id_token);

      // 更新畫面
      document.getElementById("status").innerText = "已登入";
      document.getElementById("user-info").style.display = "block";

      document.getElementById("welcome").innerText = `哈囉，${user.name || user["cognito:username"]}！`;
      document.getElementById("email").innerText = `目前登入帳號：${user.email}`;

      if (user.picture) {
        document.getElementById("avatar").src = user.picture;
      } else {
        document.getElementById("avatar").style.display = "none";
      }

      // 跳轉到使用者專屬頁面
      window.location.href = `https://www.ducky-test.tw/${user["cognito:username"]}/index.html`;
    })
    .catch(err => {
      console.error("登入錯誤：", err);
    });
  }
</script>
