<div id="status">尚未登入</div>
<div id="user-info" style="display:none;">
  <h2 id="welcome"></h2>
  <p id="email"></p>
  <img id="avatar" src="" alt="大頭照" style="width:80px; border-radius:50%;">
</div>

<script>
  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
    return JSON.parse(jsonPayload);
  }

  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");

  if (code) {
    fetch("https://ducky-unique123.auth.us-east-1.amazoncognito.com/oauth2/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `grant_type=authorization_code&client_id=5ug0mo74oh6ma666kd9dkpbqk5&code=${code}&redirect_uri=https://www.ducky-test.tw/index.html`
    })
    .then(res => res.json())
    .then(data => {
      const user = parseJwt(data.id_token);

      // 更新畫面
      document.getElementById("status").innerText = "已登入";
      document.getElementById("user-info").style.display = "block";

      document.getElementById("welcome").innerText = `哈囉，${user.name || user["cognito:username"]}！`;
      document.getElementById("email").innerText = `目前登入帳號：${user.email}`;

      if (user.picture) {
        document.getElementById("avatar").src = user.picture;
      } else {
        document.getElementById("avatar").style.display = "none";
      }

      // 跳轉到使用者專屬頁面
      window.location.href = `https://www.ducky-test.tw/${user["cognito:username"]}/index.html`;
    })
    .catch(err => {
      console.error("登入錯誤：", err);
    });
  }
</script>
